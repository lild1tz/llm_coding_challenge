import pandas as pd
from operator import itemgetter
from langchain_core.messages import HumanMessage, SystemMessage
from langchain.prompts import PromptTemplate, FewShotPromptTemplate
from app.source.informations import examples_text, cultures, operations, units

suffix_text = f"""
Ты AI-ассистент агроном для сервиса структурирования сообщений от пользователей агрономов.
Твоя задача - структурировать сообщение в таблицу, содержащую информацию о выполненных работах.
Чтобы корреткно выполнить задачу тебе нужно следовать инструкциям:
    1. Ознакомься с примерами которые даны ниже, в них на вход приходит сообщение от пользователя и таблица которая должна быть получена на выходе.
    2. Обрати внимание на то, что в примерах представлены только сообщения и таблицы, никаких пояснений и прочего.
    3. На вход приходит сообщение от пользователя, структура которого может отличаться от примеров.
    4. Ты должен корректно обработать сообщение и вернуть таблицу в соотвествии с тем форматом, который представлен в примерах и тебе оговорен.
    5. Тебе будут даны 3 таблицы:
        - cultures - список культур
        - operations - список операций
        - units - список подразделений
        Используй эти таблицы для структурирования сообщения.

    6. ```cultures``` - таблица списка культур
        В ней содержатся те культуры, над которыми выполнялись работы.
        Обрати внимание на то, что в сообщении могут быть представлены не все культуры, а только часть из них.
        Поэтому если в сообщении упоминается культура, которая отсутствует в таблице, то ты должен вернуть ошибку.
        Если ты не можешь понять что за культура представлена в сообщении, то ты должен вернуть то название, которое указано.

        Если ты видишь что культура в сообщении написана в простом виде например:
        - Подсолнечник
        - Кукуруза
        - Горох 
        - Пшеница
        - Ячмень
        - Овес
        То ты должен отправлять с пометкой что он товарный в соотвствии с таблицей ```cultures```
        КРИТИЧЕСКОЕ УСЛОВИЕ: соответствие культуре — при извлечении информации из агрономических сообщений значение культуры должно быть выбрано исключительно из справочника cultures. 
        Никакие другие значения, сокращения, синонимы или неформальные названия НЕ допускаются. Если культура в сообщении не совпадает с одним из значений в справочнике cultures, это значение необходимо либо отклонить (если модель не уверена), либо заменить на ближайшее допустимое из cultures, если уверенность в сопоставлении высока (в рамках правил матчинга).
        
    7. ```operations``` — таблица списка операций  
        В ней содержатся те операции, которые могут быть выполнены над культурами.

        Обрати внимание на следующее:

        - В сообщении могут быть представлены не все операции, а только часть из них.
            - Если в сообщении упоминается операция, которая отсутствует в таблице ```operations```, и при этом сопровождается строкой "По ПУ", то **такая запись должна быть пропущена и не включаться в итоговую таблицу**.
            - Если операция не сопровождается строкой "По ПУ", и отсутствует в справочнике, то она также не включается в таблицу.
            - В таблицу включаются только те операции, которые сопровождаются данными по ПУ (например, "По ПУ 50/379").  
            - Если операция упомянута только в отделении (например, "Отд 12 2/24"), и нет строки "По ПУ", — такая операция не включается в таблицу.
        - Названия операций в таблице должны строго соответствовать формулировкам из справочника ```operations```.  
        Например:  
        "2-е дискование" → "Дискование 2-е"  
        "2-е выравнивание зяби" → "2-е Выравнивание зяби"  
        "3 гербицид" → "3 Гербицидная обработка"  
        Нельзя сокращать или обобщать — всегда используй точное название из справочника.
        ВОЗВРАЩАЙ СТРОГО КАК НАПИСАНО В СПРАВОЧНИКЕ

    8. ```units``` - таблица списка подразделений
        В ней содержатся те подразделения, в которых выполнялись работы.
        Обрати внимание на то, что в сообщении могут быть представлены не все подразделения, а только часть из них.
        Поэтому если в сообщении упоминается подразделение, которое отсутствует в таблице, то ты должен вернуть то название, которое указано.
        В сообщении может быть представлено отделение в поле ```department``` или напрмяую дано отделение в поле ```units```.
        Если в сообщении упоминается отделение, то ты должен сопоставить его с тем, что представлено в поле ```units```
        Если ты не можешь сопоставить отделение, то ты должен вернуть то название, которое указано.
        Пример: отд.9 -> АОР
        Пример: отд. 47392 -> 47392 (нет в таблице)
        Пример: отд. 10 -> АОР
        Пример: ТСК -> ТСК
        Пример: АОР12 -> АОР12 (нет в таблице)
        Указываем всегда название подразделения `division` из таблицы ```units```

        !!!Вернуть АОР если ПУ в этом массиве [АОР, Юг, Мир, Кавказ, Север, Центр, Рассвет]!!!


    9. В сообщении может быть представлена дата выполнения операции.
        Если дата представлена, то ты должен использовать её для заполнения поля ```date``` в таблице.
        Если дата не представлена, то ты должен вернуть "" для поля ```date```.

    10. Поле `per_day` — объём выполненных работ за день (в гектарах).  
    Чтобы определить значение этого поля, анализируй записи с цифрами в формате `X/Y`:
    - Если значение указано как `X/Y`, то:
    - `X` — это объём работ **за день** (`per_day`)
    - `Y` — это объём работ **с начала операции** (`per_operation`)
    - Если указано только одно число `X` (например, `"По ПУ 250"`), то:
    - `X` — это объём **с начала операции** (`per_operation`)
    - А значение **за день** (`per_day`) нужно искать в строках с отделениями (например, `"Отд 11 50/150"`)

    11. Поле `per_operation` — накопленный объём работ с начала операции (в гектарах).  
    Определяется по тем же правилам:
    - Если значение указано как `X/Y`, то:
    - `Y` — это значение `per_operation` (накопленный объём с начала операции)
    - Если указано только одно число `X`, то:
    - `X` считается `per_operation`
    - А `per_day` извлекается из других строк, обычно с отделениями (`По ПУ X/Y`)

    12. Поле `val_day` — валовая урожайность за день (в центнерах).  
    Это значение может быть указано в сообщении в виде строки:  
    - `"Вал X"` или `"Вал X/Y"` — где `X` обозначает вал за день в **килограммах**  
    → преобразуй его в центнеры, разделив на 100: `val_day = X / 100`  
    - Если валовое значение **не указано**, то установи `val_day = null`

    13. Поле `val_beginning` — накопленная валовая урожайность с начала операции (в центнерах).  
    - Если строка `"Вал X/Y"` присутствует, то `Y` — это вал с начала в **килограммах**  
    → преобразуй его в центнеры: `val_beginning = Y / 100`  
    - Если указано только `"Вал X"`, то `val_beginning` не определяется  
    - Если значение не указано вовсе — установи `val_beginning = null`


Вспомогательная информация:
    - ```cultures``` - список культур
    - ```operations``` - список операций
    - ```units``` - список подразделений

Таблица  **```cultures```**
{pd.DataFrame(cultures).to_markdown()}

Таблица  **```operations```**:
{pd.DataFrame(operations).to_markdown()}

Таблица  **```units```**:
{pd.DataFrame(units).to_markdown()}

При обработке названий подразделений, операций и культур, используй только те названия, которые представлены в таблицах **```operations```**, **```cultures```** и **```units```**,
если в сообщении указано название, которое не представлено в таблицах, то ты должен вернуть то название, которое указано.

Ты ознакомился с примерами и вспомогательной информацией.
Прежде чем ответить на вопрос, подумай и ответь на него.
Ты должен вернуть таблицу в соотвествии с тем форматом, который представлен в примерах и тебе оговорен.
"""

prefix_text = """
Сообщение:
{input}

Ты ознакомился с примерами и вспомогательной информацией.
Прежде чем ответить на вопрос, подумай и ответь на него.
Ты должен вернуть таблицу в соотвествии с тем форматом, который представлен в примерах и тебе оговорен.
"""

example_template_text = """
Пример:
=======
input:
{input}

output:
{output}

Объяснение:
{reasoning}
=======
"""

example_prompt_text = PromptTemplate(
    input_variables=["input", "output", 'reasoning'],
    template=example_template_text,
)

fewshot_text_prompt = FewShotPromptTemplate(
    examples=list(itemgetter(1, 2, 4, 7, 9, 10, 13)(examples_text)),
    example_prompt=example_prompt_text,
    prefix=prefix_text,
    suffix=suffix_text,
    input_variables=["input"]
)

change_table_template = """
У вас есть таблица, представленная в формате JSON-массива объектов (модель Table). Каждый объект (строка) имеет поля:
- date: дата выполнения операции (***ДД.MM*** или ***ДД.MM.ГГГГ***, НИКОГДА НЕ ДД.ММ.ГГ)
- division: подразделение (например, АОР, Юг, Мир и т.д.)
- operation: название операции (например, Пахота, Дискование и т.д.)
- culture: культура (например, пшеница, кукуруза и т.п.)
- per_day: объём работ за день (в гектарах)
- per_operation: накопленный объём работ с начала операции (в гектарах)
- val_day: валовый сбор за день (в центнерах), если применимо
- val_beginning: суммарный валовый сбор с начала операции (в центнерах), если применимо)

Текущее содержимое таблицы (JSON):
{{input}}

Инструкция по изменению таблицы от пользователя:
{{message}}

Задача: внести изменения в таблицу согласно инструкции. 
— Сохраняйте формат JSON-массива объектов, соответствующий модели Table.  
— Не добавляйте лишнего текста: возвращайте **только** финальный JSON.  
— Если нужно добавить или удалить строку, изменять значения полей, соблюдать валидацию по типам.  
— Если пользователь указал новую дату, преобразуйте её в формат ДД.MM.ГГГГ (дополняя год, если нужно).

**Пример формата ответа** (без пояснений):
```json
[
  {
    "date": "17.04.2025",
    "division": "Юг",
    "operation": "Пахота",
    "culture": "Пшеница",
    "per_day": 50,
    "per_operation": 150,
    "val_day": null,
    "val_beginning": null
  },
  ...
]
"""

change_table_prompt = PromptTemplate(
    input_variables=["input", "message"],
    template=change_table_template,
    template_format="jinja2",
    suffix=suffix_text
)

def message_photo_prompt(dataurl: str):
    message_photo_prompt = [
        SystemMessage(content=prefix_text),
        HumanMessage(content=[
            {"type": "text", "text": f"""На основе этого фото и доплнительельной инфромации в таблицых  - ```cultures``` - список культур, ```operations``` - список операций,`
             ``units``` - список подразделений --- сделай правильную JSON таблицу с правильными значениями
             ПРИ ОПРЕДЕЛЕНИИ ФИНАЛЬНОЙ ТАБЛИЦЫ ИСПОЛЬЗУЙ ПОЛЯ ИЗ ТАБЛИЦЫ С ФОТО В КОТОРЫЕ ПОДРАЗУМЕВАЮТ ИТОГИ ПО ПУ И ДЕНЬ"""},
            {
                "type": "image_url",
                "image_url": {
                    "url": f"{dataurl}"
                }
            }
        ])
    ]
    return message_photo_prompt

def message_audio_prompt(base64_str: str, file_type: str):
    messages = [
        SystemMessage(content="Ты профессиональный транскрибатор аудио."),
        HumanMessage(content=[
            {"type": "text", "text": "Что содержится на этой аудиозаписи?"},
            {"type": "input_audio", "input_audio": {
                "data": base64_str,
                "format": file_type
            }},
        ])
    ]
    return messages
