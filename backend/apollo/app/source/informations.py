from app.utils import safe_json

cultures = [
      "Вика+Тритикале",
      "Горох на зерно",
      "Горох товарный",
      "Гуар",
      "Конопля",
      "Кориандр",
      "Кукуруза кормовая",
      "Кукуруза семенная",
      "Кукуруза товарная",
      "Люцерна",
      "Многолетние злаковые травы",
      "Многолетние травы прошлых лет",
      "Многолетние травы текущего года",
      "Овес",
      "Подсолнечник кондитерский",
      "Подсолнечник семенной",
      "Подсолнечник товарный",
      "Просо",
      "Пшеница озимая на зеленый корм",
      "Пшеница озимая семенная",
      "Пшеница озимая товарная",
      "Рапс озимый",
      "Рапс яровой",
      "Свекла сахарная",
      "Сорго",
      "Сорго кормовой",
      "Сорго-суданковый гибрид",
      "Соя семенная",
      "Соя товарная",
      "Чистый пар",
      "Чумиза",
      "Ячмень озимый",
      "Ячмень озимый семенной"
    ]


units = [
    { "division": "АОР", "pu": "Кавказ", "department": "18" },
    { "division": "АОР", "pu": "Кавказ", "department": "19" },
    { "division": "АОР", "pu": "Север", "department": "3" },
    { "division": "АОР", "pu": "Север", "department": "7" },
    { "division": "АОР", "pu": "Север", "department": "10" },
    { "division": "АОР", "pu": "Север", "department": "20" },
    { "division": "АОР", "pu": "Центр", "department": "1" },
    { "division": "АОР", "pu": "Центр", "department": "4" },
    { "division": "АОР", "pu": "Центр", "department": "5" },
    { "division": "АОР", "pu": "Центр", "department": "6" },
    { "division": "АОР", "pu": "Центр", "department": "9" },
    { "division": "АОР", "pu": "Юг", "department": "11" },
    { "division": "АОР", "pu": "Юг", "department": "12" },
    { "division": "АОР", "pu": "Юг", "department": "16" },
    { "division": "АОР", "pu": "Юг", "department": "17" },
    { "division": "АОР", "pu": "Рассвет", "department": "" },
    { "division": "ТСК", "pu": "Нет ПУ", "department": "Нет отделения" },
    { "division": "АО Кропоткинское", "pu": "Нет ПУ", "department": "Нет отделения" },
    { "division": "Восход", "pu": "Нет ПУ", "department": "Нет отделения" },
    { "division": "Колхоз Прогресс", "pu": "Нет ПУ", "department": "Нет отделения" },
    { "division": "Мир", "pu": "Нет ПУ", "department": "Нет отделения" },
    { "division": "СП Коломейцево", "pu": "Нет ПУ", "department": "Нет отделения" }
  ]
  
operations = [
      {
        "name": "1-я междурядная культивация",
        "note": "На всех культурах кроме пшеницы, ячменя"
      },
      {
        "name": "2-я междурядная культивация",
        "note": "На всех культурах кроме пшеницы, ячменя"
      },
      {
        "name": "Боронование довсходовое",
        "note": ""
      },
      {
        "name": "Внесение минеральных удобрений",
        "note": ""
      },
      {
        "name": "Выравнивание зяби",
        "note": ""
      },
      {
        "name": "2-е Выравнивание зяби",
        "note": ""
      },
      {
        "name": "Гербицидная обработка",
        "note": "На свекле их 4 шт, на остальных культурах 1"
      },
      {
        "name": "1 Гербицидная обработка",
        "note": "На свекле их 4 шт, на остальных культурах 1"
      },
      {
        "name": "2 Гербицидная обработка",
        "note": "На свекле их 4 шт, на остальных культурах 1"
      },
      {
        "name": "3 Гербицидная обработка",
        "note": "На свекле их 4 шт, на остальных культурах 1"
      },
      {
        "name": "4 Гербицидная обработка",
        "note": "На свекле их 4 шт, на остальных культурах 1"
      },
      {
        "name": "Дискование",
        "note": ""
      },
      {
        "name": "Дискование 2-е",
        "note": ""
      },
      {
        "name": "Дискование 3-е",
        "note": ""
      },
      {
        "name": "Инсектицидная обработка",
        "note": ""
      },
      {
        "name": "Культивация",
        "note": ""
      },
      {
        "name": "Пахота",
        "note": ""
      },
      {
        "name": "Подкормка",
        "note": ""
      },
      {
        "name": "2-я подкормка",
        "note": ""
      },
      {
        "name": "Предпосевная культивация",
        "note": ""
      },
      {
        "name": "Прикатывание посевов",
        "note": ""
      },
      {
        "name": "Сев",
        "note": ""
      },
      {
        "name": "Сплошная культивация",
        "note": ""
      },
      {
        "name": "Уборка",
        "note": ""
      },
      {
        "name": "Функицидная обработка",
        "note": ""
      },
      {
        "name": "Чизлевание",
        "note": ""
      }
    ]

examples_text = [
  {
    "number": 1,
    "reasoning": "1. Первая строка сообщения содержит описание операции и культуры: «Пахота зяби под сою». Операция «Пахота» определяется по ключевому слову, сопоставляется со значением из справочника operations. Культура «за» нормализуется как «Соя товарная» по справочнику cultures. Далее указаны данные «По ПУ 7/1402» и «Отд 17 7/141», из которых берутся: 7 — объём за день, 1402 — с начала операции. Отделение 17 в справочнике units принадлежит подразделению «АОР».\n\n2. Вторая строка — «Вырав-ие зяби под куку/силос». Операция нормализуется как «Выравнивание зяби» (по наличию ключевого слова «вырав» и справочнику operations), культура «куку/силос» приводится к форме «Кукуруза кормовая» (по справочнику cultures). Далее «По ПУ 16/16» и «Отд 12 16/16» — оба значения 16 подтверждают площадь за день и с начала. Отделение 12 также соответствует подразделению «АОР».\n\n3. Третья строка — «Вырав-ие зяби под сах/свёклу». Аналогично предыдущей, операция — «Выравнивание зяби», культура — «Свекла сахарная». Из «По ПУ 67/912» извлекается: 67 — за день, 912 — с начала. Отделение 12 по справочнику принадлежит подразделению «АОР».\n\n4. Четвёртая строка — «2-ое диск-ие сах/свёкла». Операция нормализуется как «Дискование 2-е» по наличию «2-е диск» и сопоставлению со справочником operations. Культура — «Свекла сахарная». Из «По ПУ 59/1041» берутся значения: 59 — за день, 1041 — с начала. Отделение 17 соответствует подразделению «АОР».\n\nИтоговая таблица формируется по принципу: \n- Операция определяется по ключевым словам и сопоставляется с operations.\n- Культура нормализуется по cultures.\n- Подразделение находится по номеру отделения из units.\n- Значения га за день и с начала берутся из строк с ПУ (формат X/Y).",
    "input": "Пахота зяби под мн тр\nПо Пу 26/488\nОтд 12 26/221\n\nПредп культ под оз пш\nПо Пу 215/1015\nОтд 12 128/317\nОтд 16 123/529\n\n2-е диск сах св под оз пш\nПо Пу 22/627\nОтд 11 22/217\n\n2-е диск сои под оз пш\nПо Пу 45/1907\nОтд 12 45/299",
    "output": safe_json([
      {
        "date": None,
        "division": "АОР",
        "operation": "Пахота",
        "culture": "Многолетние травы текущего года",
        "per_day": 26,
        "per_operation": 488,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Предпосевная культивация",
        "culture": "Пшеница озимая товарная",
        "per_day": 215,
        "per_operation": 1015,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Дискование 2-е",
        "culture": "Пшеница озимая товарная",
        "per_day": 22,
        "per_operation": 627,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Дискование 2-е",
        "culture": "Пшеница озимая товарная",
        "per_day": 45,
        "per_operation": 1907,
        "val_day": None,
        "val_beginning": None
      }
    ])
  },
  {
    "number": 2,
    "reasoning": "1. Сообщение состоит из блоков, каждый из которых содержит: название операции и культуры, строку с ПУ (формат «По ПУ X/Y») и строку с отделением (формат «Отд N X/Y»).\n\n2. Операция определяется по ключевым словам:\n- «Пахота зяби» → операция «Пахота» по справочнику operations.\n- «Вырав-ие зяби» → операция «Выравнивание зяби».\n- «2-ое диск-ие» → операция «Дискование 2-е» (по фразе «2-ое диск»).\n\n3. Культура извлекается из конструкции «под <название>» и нормализуется по справочнику cultures:\n- «сою» → «Соя товарная»\n- «кук/силос» → «Кукуруза кормовая»\n- «сах/свёклу» → «Свекла сахарная»\n\n4. Значения площади за день и с начала операции извлекаются из строки «По ПУ X/Y», где X — площадь за день, Y — с начала операции. Эти значения подставляются в соответствующие колонки таблицы.\n\n5. Отделение определяется по строке «Отд N». Значение N (например, 17) сопоставляется с таблицей units: отделение 17 принадлежит подразделению «АОР». Это значение подставляется в колонку «Подразделение».\n\n6. Каждая строка таблицы соответствует одному блоку в сообщении. Формируется запись: подразделение (из таблицы units), операция (по ключевым словам), культура (по справочнику), за день (X), с начала (Y).",
    "input": "Пахота зяби под сою\nПо ПУ 7/1402\nОтд 17 7/141\n\nВырав-ие зяби под кук/силос\nПо ПУ 16/16\nОтд 12 16/16\n\nВырав-ие зяби под сах/свёклу\nПо ПУ 67/912\nОтд 12 67/376\n\n2-ое диск-ие сах/свёкла\nПо ПУ 59/1041\nОтд 17 59/349",
    "output": safe_json([
      {
        "date": None,
        "division": "АОР",
        "operation": "Пахота",
        "culture": "Соя товарная",
        "per_day": 7,
        "per_operation": 1402,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Выравнивание зяби",
        "culture": "Кукуруза кормовая",
        "per_day": 16,
        "per_operation": 16,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Выравнивание зяби",
        "culture": "Свекла сахарная",
        "per_day": 67,
        "per_operation": 912,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Дискование 2-е",
        "culture": "Свекла сахарная",
        "per_day": 59,
        "per_operation": 1041,
        "val_day": None,
        "val_beginning": None
      }
    ])
  },
  {
    "number": 3,
    "reasoning": "1. Первая строка сообщения — дата: '12.10'. Это значение попадает в поле 'date'.\n\n2. Строка 'Внесение мин удобрений под оз пшеницу 2025 г ПУ Юг 149/7264' содержит информацию:\n- Операция 'Внесение мин удобрений' соответствует точному значению из справочника operations: 'Внесение минеральных удобрений'.\n- Культура указывается как 'оз пшеницу', что трактуется как 'Пшеница озимая'. Так как не указано, что она семенная, выбираем наиболее вероятное по умолчанию значение из справочника cultures: 'Пшеница озимая товарная'.\n- Площадь за день и с начала извлекается из '149/7264', соответственно 149 в 'per_day', 7264 в 'per_operation'.\n\n3. Строка 'Отд 17 -149/1443' указывает на отделение 17. Согласно справочнику units, отделение 17 относится к подразделению 'АОР'. Это значение помещается в поле 'division'.\n\n4. Поля 'val_day' и 'val_beginning' остаются пустыми, так как валовые показатели (в центнерах) в сообщении не указаны.\n\n5. Таким образом, из одного блока текста формируется одна строка таблицы с соответствующим разбором всех необходимых значений.",
    "input": "12.10\nВнесение мин удобрений под оз пшеницу 2025 г ПУ Юг 149/7264\nОтд 17 -149/1443",
    "output": safe_json([
      {
        "date": "12.10",
        "division": "АОР",
        "operation": "Внесение минеральных удобрений",
        "culture": "Пшеница озимая товарная",
        "per_day": 149,
        "per_operation": 7264,
        "val_day": None,
        "val_beginning": None
      }
    ])
  },
  {
    "number": 4, 
    "reasoning": "1. В первой строке указано 'Север'. По справочнику units, ПУ 'Север' включает отделения 3, 7, 10, 20. Следовательно, все строки с этими отделениями относятся к подразделению 'АОР'.\n\n2. Строка 'Отд7 пах с св 41/501' интерпретируется как:\n- 'Отд7' → подразделение 'АОР'\n- 'пах' → операция 'Пахота' из operations\n- 'с св' → культура 'Свекла сахарная' из cultures\n- '41/501' → per_day = 41, per_operation = 501\n\n3. Строка 'Отд20 20/281 по пу 61/793':\n- 'Отд20' → подразделение 'АОР'\n- контекста операции и культуры нет, но учитывая, что структура повторяет предыдущую строку, это также относится к 'Пахота подсолнечник' (из итоговой таблицы)\n- per_day = 20, per_operation = 281\n- 'по пу 61/793' → дублирует per_day/per_operation для другой записи, разобранной ниже\n\n4. Строка 'Отд 3 пах подс.60/231':\n- 'Отд 3' → 'АОР'\n- 'пах' → 'Пахота'\n- 'подс.' → 'Подсолнечник товарный'\n- '60/231' → per_day = 60, per_operation = 231\n\n5. Строка 'По пу 231' — общая справочная информация, не влияет на конкретные записи.\n\n6. 'Диск к. Сил отд 7. 32/352':\n- 'Диск' → 'Дискование'\n- 'к. Сил' → расшифровывается как 'Кукуруза кормовая'\n- 'Отд 7' → 'АОР'\n- '32/352' → per_day = 32, per_operation = 484 (перепроверяется по 'ПУ 484' ниже)\n\n7. 'Диск под Оз п езубов 20/281':\n- 'Диск' → 'Дискование'\n- 'Оз п' → 'Пшеница озимая'\n- 'езубов' вероятно имя, не используется\n- '20/281' → per_day = 20, per_operation = 281\n\n8. 'Диск под с. Св отд 10 83/203 пу-1065га':\n- 'Диск' → 'Дискование'\n- 'с. Св' → 'Свекла сахарная'\n- 'отд 10' → 'АОР'\n- '83/203' → per_day = 83, а per_operation переписывается из 'пу-1065га' → 1065\n\n9. Все строки итоговой таблицы формируются по этим правилам, используя словари operations и cultures для нормализации операций и культур, и units — для определения подразделения по номеру отделения.",
    "input": "Север\nОтд7 пах с св 41/501\nОтд20 20/281 по пу 61/793\nОтд 3 пах подс.60/231\nПо пу 231\n\nДиск к. Сил отд 7. 32/352\nПу- 484\n\nДиск под Оз п езубов 20/281\nДиск под с. Св отд 10 83/203 пу-1065га",
    "output": safe_json([
      {
        "date": None,
        "division": "АОР",
        "operation": "Пахота",
        "culture": "Свекла сахарная",
        "per_day": 61,
        "per_operation": 793,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Пахота",
        "culture": "Подсолнечник товарный",
        "per_day": 60,
        "per_operation": 231,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Дискование",
        "culture": "Кукуруза кормовая",
        "per_day": 32,
        "per_operation": 484,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Дискование",
        "culture": "Пшеница озимая товарная",
        "per_day": 20,
        "per_operation": 281,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Дискование",
        "culture": "Свекла сахарная",
        "per_day": 83,
        "per_operation": 203,
        "val_day": None,
        "val_beginning": None
      }
    ])
  },
  {
    "number": 5,
    "reasoning": "1. Первая строка: 'Внесение удобрений под рапс отд 7 -138/270'\n- 'Внесение удобрений' → нормализуется до 'Внесение минеральных удобрений' из справочника `operations`\n- 'рапс' → уточняется как 'Рапс озимый' из справочника `cultures`\n- 'отд 7' → по справочнику `units`, отделение 7 принадлежит ПУ 'Север', подразделение 'АОР'\n- '138/270' → per_day = 138, per_operation = 270\n\n2. Вторая строка: 'Дискование под рапс 40/172'\n- 'Дискование' → операция из `operations`\n- 'рапс' → 'Рапс озимый'\n- '40/172' → per_day = 40, per_operation = 172\n- Отделение и ПУ не указаны, но логически продолжается предыдущая строка (контекст тот же), значит используем тот же 'отд 7', т.е. 'АОР'\n\n3. Третья строка: 'Диск после Кук сил отд 7-32/352 по пу 484га'\n- 'Диск' → 'Дискование'\n- 'Кук сил' → расшифровывается как 'Кукуруза кормовая' из справочника `cultures`\n- 'отд 7' → 'АОР'\n- '32/352' → per_day = 32\n- 'по пу 484га' → per_operation = 484 (взято из явного упоминания ПУ)\n\n4. Все строки разбираются с использованием:\n- `operations` для нормализации названия операции\n- `cultures` для уточнения названия культуры\n- `units` для определения подразделения по номеру отделения",
    "input": "Внесение удобрений под рапс отд 7\n-138/270\nДискование под рапс 40/172\nДиск после Кук сил отд 7 - 32/352 по пу 484га",
    "output": safe_json([
      {
        "date": None,
        "division": "АОР",
        "operation": "Внесение минеральных удобрений",
        "culture": "Рапс озимый",
        "per_day": 138,
        "per_operation": 270,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Дискование",
        "culture": "Рапс озимый",
        "per_day": 40,
        "per_operation": 172,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Дискование",
        "culture": "Кукуруза кормовая",
        "per_day": 32,
        "per_operation": 484,
        "val_day": None,
        "val_beginning": None
      }
    ])
  },
  {
    "number": 6,
    "reasoning": "1. Первая строка: '10.03 день' → дата операции = '10.03'\n\n2. Вторая строка: '2-я подкормка озимых, ПУ \"Юг\" - 1749/2559'\n- '2-я подкормка' → находится в справочнике `operations`\n- 'озимых' → уточняется как 'Пшеница озимая товарная' по слову из `cultures` с доминирующей связью с подкормками\n- 'ПУ \"Юг\"' → по таблице `units` соответствует подразделению 'АОР'\n- '1749/2559' → per_day = 1749, per_operation = 2559\n\n3. Третья и четвёртая строки содержат дополнительную разбивку по технике (амазон, пневмоход), но они игнорируются, так как в таблице сохраняется итоговая агрегация\n\n4. Последующие строки:\n- 'Отд11', 'Отд 12', 'Отд 16', 'Отд 17' → соответствуют подразделению 'АОР' согласно справочнику `units`, но в финальной таблице информация агрегирована на уровень ПУ и не разделяется по отделениям\n\n5. Итог:\n- Одна строка в таблице, так как всё относится к одной операции, культуре, дате, подразделению\n- Использованы: справочник `operations`, `cultures`, `units`",
    "input": "10.03 день\n2-я подкормка озимых, ПУ \"Юг\" - 1749/2559\n(в т.ч Амазон - 1082/1371\nПневмоход - 667/1188)\n\nОтд11 - 307/307 (амазон 307/307)\nОтд 12 - 671/671 (амазон 318/318; пневмоход 353/353)\nОтд 16 - 462/1272 (амазон 148/437; пневмоход 314/835)\nОтд 17 - 309/309 (амазон 309/309)",
    "output": safe_json([
      {
        "date": "10.03",
        "division": "АОР",
        "operation": "2-я подкормка",
        "culture": "Пшеница озимая товарная",
        "per_day": 1749,
        "per_operation": 2559,
        "val_day": None,
        "val_beginning": None
      }
    ])
  },
  {
    "number": 7,
    "reasoning": "1. Первая строка: 'Уборка свеклы 27.10. день'\n- 'Уборка' присутствует в справочнике `operations`\n- 'свеклы' → уточняется как 'Свекла сахарная' по справочнику `cultures`\n- '27.10' → дата операции\n\n2. Строка 'Отд10 - 45/216' содержит объёмы по отделению, но основная агрегация идёт по ПУ:\n- 'По ПУ 45/1569' → 45 (per_day), 1569 (per_operation)\n\n3. Строка 'Вал 1259680/6660630' → 1259680 (вал за день), 6660630 (вал с начала)\n- Эти значения делятся на 100, чтобы перевести из кг в центнеры: 1259680 ÷ 100 = 12596.80, 6660630 ÷ 100 = 66606.30\n- Это значения для полей 'val_day' и 'val_beginning'\n\n4. Остальная информация ('Урожайность', 'на завод', 'кагат', 'остаток', 'Оз', 'Дигестия') используется для отчётности, но не входит в итоговую таблицу\n\n5. Подразделение определяется через ПУ 45 → в справочнике `units` соответствует 'АОР'\n\n6. Итог: все поля заполняются из входного текста по правилам агрегации, справочникам `operations`, `cultures`, `units` и округления центнеров.",
    "input": "Уборка свеклы 27.10. день\nОтд10 - 45/216\nПо ПУ 45/1569\nВал 1259680/6660630\nУрожайность 279.9/308.3\nПо ПУ 1259680/41630060\nНа завод 1811630/6430580\nПо ПУ 1811630/41400550\nПоложено в кагат 399400\nВвезено с кагата 951340\nОстаток 230060\nОз-9,04/12,58\nДигестия -14,50/15,05",
    "output": safe_json([
      {
        "date": "27.10",
        "division": "АОР",
        "operation": "Уборка",
        "culture": "Свекла сахарная",
        "per_day": 45,
        "per_operation": 1569,
        "val_day": 12596.80,
        "val_beginning": 66606.30
      }
    ])
  },
  {
    "number": 8,
    "reasoning": "1. Каждое подсообщение начинается с названия операции и культуры. Операция определяется по справочнику `operations`, культура — по `cultures`. Пример: 'Пахота под сах св' → операция: 'Пахота', культура: 'Свекла сахарная'.\n\n2. Строка 'По ПУ' указывает на суммарные значения по производственному участку. Первое число — это 'per_day' (за день), второе — 'per_operation' (с начала операции): 'По ПУ 77/518' → 77 и 518 соответственно.\n\n3. Отдельные строки 'Отд' дают детализацию по отделениям, но не используются в итоговой таблице, если есть строка по ПУ. Пример: 'Отд 12 46/298', 'Отд 16 21/143' и 'Отд 17 10/17' суммируются в строке по ПУ.\n\n4. Подразделение 'АОР' определяется на основе номера отделения из справочника `units`. Например, 'Отд 12' → ПУ 'Юг' → 'АОР'. Поэтому все строки в финальной таблице имеют подразделение 'АОР'.\n\n5. Культура 'оз зел корм' в сообщении трактуется как 'Пшеница озимая на зеленый корм' — содержится напрямую в `cultures`. Последняя строка: 'Уборка сои (семенной)' + 'Отд 11 65/65' + 'Вал 58720'\n- '65' → per_day и per_operation (совпадают)\n- 'Вал 58720' → это вал за день, переводится в центнеры: 58720 ÷ 100 = 587,20\n- Культура: 'Соя семенная'\n- Подразделение: 'АОР' (по `units` — отделение 11 принадлежит ПУ Юг, а тот принадлежит 'АОР')",
    "input": "Пахота под сах св\nПо Пу 77/518\nОтд 12 46/298\nОтд 16 21/143\nОтд 17 10/17\n\nЧизел под оз ячмень\nПо Пу 22/640\nОтд 11 22/242\n\nЧизел под оз зел корм\nОтд 11 40/40\n\nДиск оз пшеницы\nПо Пу 28/8872\nОтд 17 28/2097\n\n2-е диск под сах св\nПо Пу 189/1763\nОтд 11 60/209\nОтд 12 122/540\nОтд 17 7/172\n\nДиск кук силос\nПо Пу 6/904\nОтд 11 6/229\n\nПрик под оз ячмень\nПо Пу 40/498\nОтд 11 40/100\n\nУборка сои (семенной)\nОтд 11 65/65\nВал 58720\nУрож 9",
    "output": safe_json([
      {
        "date": None,
        "division": "Юг",
        "operation": "Пахота",
        "culture": "Свекла сахарная",
        "per_day": 77,
        "per_operation": 518,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Чизелевание",
        "culture": "Ячмень озимый",
        "per_day": 22,
        "per_operation": 640,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Чизелевание",
        "culture": "Пшеница озимая на зеленый корм",
        "per_day": 40,
        "per_operation": 40,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Дискование",
        "culture": "Пшеница озимая товарная",
        "per_day": 28,
        "per_operation": 8872,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Дискование 2-е",
        "culture": "Свекла сахарная",
        "per_day": 189,
        "per_operation": 1763,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Дискование",
        "culture": "Кукуруза кормовая",
        "per_day": 6,
        "per_operation": 904,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Прикатывание посевов",
        "culture": "Ячмень озимый",
        "per_day": 40,
        "per_operation": 498,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Уборка",
        "culture": "Соя семенная",
        "per_day": 65,
        "per_operation": 65,
        "val_day": "587,20",
        "val_beginning": None
      }
    ])
  },
  {
    "number": 9,
    "reasoning": "1. Каждое подсообщение начинается с названия операции и культуры. Операция извлекается по ключевому слову из справочника `operations`, а культура — из `cultures`. Например, 'Пахота под сах св' → операция: 'Пахота', культура: 'Свекла сахарная'.\n\n2. Строка 'По Пу' содержит данные по производственному участку (ПУ). Первое число — это 'per_day' (за день), второе — 'per_operation' (с начала операции). Например, 'По Пу 91/609' → per_day: 91, per_operation: 609.\n\n3. Если отсутствует строка 'По Пу', используются только данные из 'Отд'. Например, 'Чизел под оз зел корм' → 'Отд 11 60/100' → per_day: 60, per_operation: 100.\n\n4. Для определения подразделения используется справочник `units`. Например, 'Отд 11' принадлежит ПУ 'Юг', который в свою очередь принадлежит 'АОР'. Следовательно, все строки получают 'АОР' как подразделение.\n\n5. Строка 'Уборка сои семенной' + 'Отд 11 29/94' указывает на операцию 'Уборка' и культуру 'Соя семенная'.\n- per_day: 29\n- per_operation: 94\n- 'Вал 37400/96120' указывает на вал за день и вал с начала в килограммах. Значения преобразуются в центнеры: 37400 ÷ 100 = 374,00 и 96120 ÷ 100 = 961,20 → поля 'val_day' и 'val_beginning'.\n\n6. Специфика названий культур:\n- 'оз зел корм' → трактуется как 'Пшеница озимая на зеленку' (на основе логики и `cultures`)\n- 'оз ячмень' → 'Ячмень озимый'\n- 'сах св' → 'Свекла сахарная'\n- 'кук силос' → 'Кукуруза кормовая'\n\n7. В случае если есть строка 'По Пу' и детальные строки 'Отд', данные берутся из 'По Пу'. Строки 'Отд' используются только если 'По Пу' отсутствует.",
    "input": "Пахота под сах св\nПоПу 91/609\nОтд 11 13/73\nОтд 12 49/347\nОтд 16 20/163\nОтд 17 9/26\n\nЧизел под оз зел корм\nОтд 11 60/100\n\n2-е диск под сах св\nПо Пу 53/1816\nОтд 12 53/593\n\nДиск кук силос\nПо Пу 66/970\nОтд 11 66/295\n\nДиск сах св\nОтд 12 13/13\n\nПрикат под оз ячмень\nПо Пу 40/538\nОтд 11 40/140\n\nУборка сои семенной\nОтд 11 29/94\nВал 37400/96120\nУрож 12,9/10,2",
    "output": safe_json([
      {
        "date": None,
        "division": "Юг",
        "operation": "Пахота",
        "culture": "Свекла сахарная",
        "per_day": 91,
        "per_operation": 609,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Чизелевание",
        "culture": "Пшеница озимая на зеленку",
        "per_day": 60,
        "per_operation": 100,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Дискование 2-е",
        "culture": "Свекла сахарная",
        "per_day": 53,
        "per_operation": 1816,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Дискование",
        "culture": "Кукуруза кормовая",
        "per_day": 66,
        "per_operation": 970,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Дискование",
        "culture": "Свекла сахарная",
        "per_day": 13,
        "per_operation": 13,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Прикатывание посевов",
        "culture": "Ячмень озимый",
        "per_day": 40,
        "per_operation": 538,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Уборка",
        "culture": "Соя семенная",
        "per_day": 29,
        "per_operation": 94,
        "val_day": 374.00,
        "val_beginning": 961.20
      }
    ])
  },
  {
    "number": 10,
    "reasoning": "1. Каждая строка, начинающаяся с глагола, указывает на операцию и культуру. Операция определяется по словарю `operations`, культура — по `cultures`. Примеры:\n- \"Пахота под сах св\" → операция: \"Пахота\", культура: \"Свекла сахарная\"\n- \"Чизел под оз ячмень\" → операция: \"Чизелевание\", культура: \"Ячмень озимый\"\n\n2. Строка \"По Пу X/Y\" содержит площадь за день (X) и с начала операции (Y). Эти значения идут в поля `per_day` и `per_operation` соответственно.\n\n3. Если есть только строки вида \"Отд X Y/Z\" без строки \"По Пу\", берутся значения из неё.\n\n4. Подразделение определяется по номеру отделения из `units`. Например, отделения 11, 12, 16, 17 относятся к ПУ \"Юг\", а значит и к подразделению \"АОР\".\n\n5. Строка \"Уборка сах св\" + \"Отд 12 16/16\" даёт значения per_day = 16 и per_operation = 16. Далее строка \"Вал 473920\" содержит валовый сбор в килограммах → 473920 / 100 = 4739.20 ц → `val_day` = \"4 739,20\". Значение `val_beginning` отсутствует, так как не указано.\n\n6. Прочие строки, такие как \"Урож 296,2\", \"Диг - 19,19\", \"Оз - 5,33\", не участвуют в итоговой таблице, так как в шаблоне они не предусмотрены.\n\n7. Строка \"Вышка отц форм под/г\" не является допустимой операцией по словарю `operations`, поэтому пропускается.\n\n8. Культура \"мн тр\" заменяется на \"Многолетние травы текущие\" по справочнику `cultures`.\n\n9. При нескольких строках \"Отд\", данные агрегируются только в случае отсутствия строки \"По Пу\", иначе они используются как уточнение, но в таблицу не попадают.",
    "input": "Пахота под сах св\nПо Пу 88/329\nОтд 11 33/60\nОтд 12 34/204\nОтд 16 21/65\n\nПахота под мн тр\nПо Пу 10/438\nОтд 17 10/80\n\nЧизел под оз ячмень\nПо Пу 71/528\nОтд 11 71/130\n\n2-е диск под сах св\nПо Пу 80/1263\nОтд 12 80/314\n\n2-е диск под оз ячмень\nПо Пу 97/819\nОтд 17 97/179\n\nДиск кук силос\nПо Пу 43/650\nОтд 11 33/133\nОтд 12 10/148\n\nВышка отц форм под/г\nОтд 12 10/22\n\nУборка сах св\nОтд 12 16/16\nВал 473920\nУрож 296.2\nДиг - 19,19\nОз - 5,33",
    "output": safe_json([
      {
        "date": None,
        "division": "АОР",
        "operation": "Пахота",
        "culture": "Свекла сахарная",
        "per_day": 88,
        "per_operation": 329,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Пахота",
        "culture": "Многолетние травы текущие",
        "per_day": 10,
        "per_operation": 438,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Чизелевание",
        "culture": "Ячмень озимый",
        "per_day": 71,
        "per_operation": 528,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Дискование 2-е",
        "culture": "Свекла сахарная",
        "per_day": 80,
        "per_operation": 1263,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Дискование 2-е",
        "culture": "Ячмень озимый",
        "per_day": 97,
        "per_operation": 819,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Дискование",
        "culture": "Кукуруза кормовая",
        "per_day": 43,
        "per_operation": 650,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "АОР",
        "operation": "Уборка",
        "culture": "Свекла сахарная",
        "per_day": 16,
        "per_operation": 16,
        "val_day": 4739.20,
        "val_beginning": None
      }
    ])
  },
  {
    "number": 11,
    "reasoning": "1. Первая строка содержит дату и подразделение: \"20.11 Мир\" → `date` = \"20.11\", `division` = \"Мир\".\n\n2. Строка \"Пахота зяби под сою 100 га день, 1109 га от начала\" →\n   - операция: \"Пахота\" (по `operations`)\n   - культура: \"Соя товарная\" (по `cultures`, слово \"сою\")\n   - `per_day` = 100, `per_operation` = 1109\n\n3. Строка \"Выравнивание зяби под подсолнечник 47 га день, 141 га от начала\" →\n   - операция: \"Выравнивание зяби\" (по `operations`)\n   - культура: \"Подсолнечник товарный\" (по `cultures`, слово \"подсолнечник\")\n   - `per_day` = 47, `per_operation` = 141\n\n4. В строках встречаются проценты выполнения, остатки, агрегаты и осадки — эти данные в финальную таблицу не входят, так как отсутствуют соответствующие колонки.\n\n5. Указания \"Работало X агрегата\", \"Осадки: 6 мм\" не сохраняются.\n\n6. Валовый сбор (`val_day`, `val_beginning`) в сообщении отсутствует, поэтому остаются пустыми.",
    "input": "20.11 Мир\nПахота зяби под сою 100 га день, 1109 га от начала, 97%, 30 га остаток.\nРаботало 4 агрегата.\n\nВыравнивание зяби под подсолнечник\n47 га день, 141 га от начала, 29 %, остаток 565 га. Работал 1 агрегат\n\nОсадки:\nБригада 1 Воронежская – 6 мм",
    "output": safe_json([
      {
        "date": "20.11",
        "division": "Мир",
        "operation": "Пахота",
        "culture": "Соя товарная",
        "per_day": 100,
        "per_operation": 1109,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": "20.11",
        "division": "Мир",
        "operation": "Выравнивание зяби",
        "culture": "Подсолнечник товарный",
        "per_day": 47,
        "per_operation": 141,
        "val_day": None,
        "val_beginning": None
      }
    ])
  },
  {
    "number": 12,
    "reasoning": "1. Подразделение указано в начале: `ТСК` → `division` = \"ТСК\" для всех записей.\n\n2. Первая строка: `Выравнивание зяби под сою 25 га / с нарастающим 765 га` →\n   - `operation`: \"Выравнивание зяби\" (из `operations`)\n   - `culture`: \"Соя товарная\" (по слову \"сою\" и таблице `cultures`)\n   - `per_day` = 25\n   - `per_operation` = 765\n\n  Вторая строка: `Выравнивание зяби под кукурузу 131 га` →\n   - `operation`: \"Выравнивание зяби\"\n   - `culture`: \"Кукуруза товарная\" (из `cultures` по ключевому слову \"кукуруза\")\n   - `per_day` = 131\n   - `per_operation` тоже 131 (отсутствует явное значение в тексте, но оно принимается по логике как накопленный объём, равный дневному при отсутствии других данных)\n\n4. Осадки не включаются — в таблице нет соответствующего поля.\n\n5. Поля `val_day` и `val_beginning` не заполняются — данных в сообщении нет.",
    "input": "ТСК\nВыравнивание зяби под сою 25 га/ с нарастающим 765 га (13%) Остаток 5332 га\nВыравнивание зяби под кукурузу 131 га (3%) Остаток 4486 га\nОсадки 1мм",
    "output": safe_json([
      {
        "date": None,
        "division": "ТСК",
        "operation": "Выравнивание зяби",
        "culture": "Соя товарная",
        "per_day": 25,
        "per_operation": 765,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "ТСК",
        "operation": "Выравнивание зяби",
        "culture": "Кукуруза товарная",
        "per_day": 131,
        "per_operation": 131,
        "val_day": None,
        "val_beginning": None
      }
    ])
  },
  {
    "number": 13,
    "reasoning": "1. Подразделение указано в начале: `Восход` → `division` = \"Восход\" для всех строк.\n\n2. `Посев кук - 24/252` →\n   - `operation`: \"Сев\"\n   - `culture`: \"Кукуруза товарная\" (из слова \"кук\" + `cultures`)\n   - `per_day` = 24\n   - `per_operation` = 252\n\n3. `Предпосевная культ под кук - 94/490` →\n   - `operation`: \"Предпосевная культивация\"\n   - `culture`: \"Кукуруза товарная\"\n   - `per_day` = 94\n   - `per_operation` = 490\n\n4. `СЗР оз пш - 103/557` →\n   - `operation`: \"Гербицидная обработка\" (СЗР расшифровывается как средства защиты растений — в данном контексте это гербицидная)\n   - `culture`: \"Пшеница озимая товарная\"\n   - `per_day` = 103\n   - `per_operation` = 557\n\n5. `Подкормка оз рапс - 152 га` →\n   - `operation`: \"Подкормка\"\n   - `culture`: \"Рапс озимый\"\n   - `per_day` = 152\n   - `per_operation` = 152 (по умолчанию если нет другого значения)\n\n6. `подкормка овса - 97 га` →\n   - `operation`: \"Подкормка\"\n   - `culture`: \"Овес\"\n   - `per_day` = 97\n   - `per_operation` = 97\n\n7. `Довсходовое боронование подсолнечника - 524 га` →\n   - `operation`: \"Боронование довсходовое\"\n   - `culture`: \"Подсолнечник товарный\"\n   - `per_day` = 524\n   - `per_operation` = 524\n\n8. Поля `val_day` и `val_beginning` не заполняются — данные отсутствуют.",
    "input": "Восход\nПосев кук - 24/252 га\n24%\nПредпосевная культ под кук - 94/490 га 46%\nСЗР оз пш - 103/557 га\n25%\nПодкормка оз рапс - 152 га, 100%, подкормка овса - 97 га, 50%\nДовсходовое боронование подсолнечника - 524 га, 100%",
    "output": safe_json([
      {
        "date": None,
        "division": "Восход",
        "operation": "Сев",
        "culture": "Кукуруза товарная",
        "per_day": 24,
        "per_operation": 252,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "Восход",
        "operation": "Предпосевная культивация",
        "culture": "Кукуруза товарная",
        "per_day": 94,
        "per_operation": 490,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "Восход",
        "operation": "Гербицидная обработка",
        "culture": "Пшеница озимая товарная",
        "per_day": 103,
        "per_operation": 557,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "Восход",
        "operation": "Подкормка",
        "culture": "Рапс озимый",
        "per_day": 152,
        "per_operation": 152,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "Восход",
        "operation": "Подкормка",
        "culture": "Овес",
        "per_day": 97,
        "per_operation": 97,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": None,
        "division": "Восход",
        "operation": "Боронование довсходовое",
        "culture": "Подсолнечник товарный",
        "per_day": 524,
        "per_operation": 524,
        "val_day": None,
        "val_beginning": None
      }
    ])
  },
  {
    "number": 14,
    "reasoning": "1. Дата указана в начале: `30.03.25 г.` → `date` = \"30.03.25\" для всех записей.\n\n2. Подразделение указано: `СП Коломейцево` → `division` = \"СП Коломейцево\"\n\n3. `предпосевная культивация под подсолнечник день 30 га, от начала 187 га` →\n   - `operation`: \"Предпосевная культивация\"\n   - `culture`: \"Подсолнечник товарный\" (по справочнику `cultures`)\n   - `per_day` = 30\n   - `per_operation` = 187\n\n4. `сев подсолнечника день+ночь 57 га, от начала 157 га` →\n   - `operation`: \"Сев\"\n   - `culture`: \"Подсолнечник товарный\"\n   - `per_day` = 57\n   - `per_operation` = 157\n\n5. `Внесение почвенного гербицида по подсолнечнику день 82 га, от начала 82 га` →\n   - `operation`: \"Гербицидная обработка\"\n   - `culture`: \"Подсолнечник товарный\"\n   - `per_day` = 82\n   - `per_operation` = 82\n\n6. `val_day` и `val_beginning` не указаны, остаются пустыми.",
    "input": "30.03.25 г.\nСП Коломейцево\nпредпосевная культивация под подсолнечник — день 30 га, от начала 187 га (91%)\nсев подсолнечника — день+ночь 57 га, от начала 157 га (77%)\nВнесение почвенного гербицида по подсолнечнику — день 82 га, от начала 82 га (38%)",
    "output": safe_json([
      {
        "date": "30.03.25",
        "division": "СП Коломейцево",
        "operation": "Предпосевная культивация",
        "culture": "Подсолнечник товарный",
        "per_day": 30,
        "per_operation": 187,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": "30.03.25",
        "division": "СП Коломейцево",
        "operation": "Сев",
        "culture": "Подсолнечник товарный",
        "per_day": 57,
        "per_operation": 157,
        "val_day": None,
        "val_beginning": None
      },
      {
        "date": "30.03.25",
        "division": "СП Коломейцево",
        "operation": "Гербицидная обработка",
        "culture": "Подсолнечник товарный",
        "per_day": 82,
        "per_operation": 82,
        "val_day": None,
        "val_beginning": None
      }
    ])
  }
]
